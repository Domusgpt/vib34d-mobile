<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VIB34D Mobile v4 - Holographic Visualization Engine</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
            touch-action: manipulation;
        }
        
        /* Mobile-optimized canvas container */
        .canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        
        /* Single adaptive canvas - switches systems instead of overlaying */
        #main-canvas {
            width: 100%;
            height: 100%;
            background: transparent;
            touch-action: none;
        }
        
        /* Mobile-first UI overlay */
        .ui-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            padding: 15px;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .ui-overlay.hidden {
            transform: translateY(100%);
        }
        
        /* System tabs - horizontal scroll for mobile */
        .system-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .system-tab {
            flex-shrink: 0;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
            font-size: 14px;
        }
        
        .system-tab.active {
            background: rgba(0, 255, 255, 0.3);
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        /* LLM interface - prominent on mobile */
        .llm-section {
            margin-bottom: 15px;
        }
        
        .llm-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .llm-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .llm-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .llm-button:active {
            transform: scale(0.98);
        }
        
        /* Hide toggle button */
        .ui-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: #ffffff;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        /* Quick parameter controls - minimal for mobile */
        .quick-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .quick-control {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }
        
        .quick-control label {
            font-size: 12px;
            display: block;
            margin-bottom: 5px;
        }
        
        .quick-control input {
            width: 100%;
            background: transparent;
            border: none;
            color: #00ffff;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Single adaptive canvas -->
    <div class="canvas-container">
        <canvas id="main-canvas"></canvas>
    </div>
    
    <!-- UI toggle button -->
    <div class="ui-toggle" onclick="toggleUI()">‚öôÔ∏è</div>
    
    <!-- Mobile UI overlay -->
    <div class="ui-overlay" id="ui-overlay">
        <!-- System selection tabs -->
        <div class="system-tabs">
            <div class="system-tab active" onclick="switchSystem('faceted')">Faceted</div>
            <div class="system-tab" onclick="switchSystem('quantum')">Quantum</div>
            <div class="system-tab" onclick="switchSystem('holographic')">Holographic</div>
        </div>
        
        <!-- LLM interface -->
        <div class="llm-section">
            <input type="text" class="llm-input" id="llm-input" placeholder="Describe the visual you want...">
            <button class="llm-button" onclick="generateFromLLM()">ü§ñ Generate with AI</button>
        </div>
        
        <!-- Quick manual controls -->
        <div class="quick-controls">
            <div class="quick-control">
                <label>Chaos</label>
                <input type="range" min="0" max="1" step="0.1" value="0.2" oninput="updateParam('chaos', this.value)">
            </div>
            <div class="quick-control">
                <label>Speed</label>
                <input type="range" min="0.1" max="3" step="0.1" value="1" oninput="updateParam('speed', this.value)">
            </div>
            <div class="quick-control">
                <label>Intensity</label>
                <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="updateParam('intensity', this.value)">
            </div>
            <div class="quick-control">
                <label>Hue</label>
                <input type="range" min="0" max="360" step="10" value="200" oninput="updateParam('hue', this.value)">
            </div>
        </div>
    </div>

    <script type="module">
        // Mobile-optimized VIB34D engine
        class MobileVIB34DEngine {
            constructor() {
                this.canvas = document.getElementById('main-canvas');
                this.currentSystem = 'faceted';
                this.engines = {};
                this.parameters = {
                    geometry: 0,
                    gridDensity: 30,
                    chaos: 0.2,
                    morphFactor: 1.0,
                    speed: 1.0,
                    hue: 200,
                    intensity: 0.5,
                    saturation: 0.8,
                    rot4dXW: 0,
                    rot4dYW: 0,
                    rot4dZW: 0
                };
                
                this.init();
            }
            
            async init() {
                try {
                    // Load only the current system's engine to save resources
                    await this.loadSystem(this.currentSystem);
                    this.setupCanvas();
                    this.startRender();
                    console.log('‚úÖ Mobile VIB34D Engine initialized');
                } catch (error) {
                    console.error('‚ùå Mobile engine init failed:', error);
                }
            }
            
            async loadSystem(systemName) {
                if (this.engines[systemName]) return;
                
                console.log(`üì± Loading ${systemName} system for mobile...`);
                
                try {
                    switch (systemName) {
                        case 'faceted':
                            const { VIB34DIntegratedEngine } = await import('./src/core/Engine.js');
                            this.engines.faceted = new VIB34DIntegratedEngine();
                            break;
                        case 'quantum':
                            const { QuantumEngine } = await import('./src/quantum/QuantumEngine.js');
                            this.engines.quantum = new QuantumEngine();
                            break;
                        case 'holographic':
                            const { RealHolographicSystem } = await import('./src/holograms/RealHolographicSystem.js');
                            this.engines.holographic = new RealHolographicSystem();
                            break;
                    }
                    console.log(`‚úÖ ${systemName} system loaded`);
                } catch (error) {
                    console.error(`‚ùå Failed to load ${systemName}:`, error);
                }
            }
            
            setupCanvas() {
                const rect = this.canvas.getBoundingClientRect();
                const dpr = Math.min(window.devicePixelRatio || 1, 2); // Cap at 2x for performance
                
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                
                // Setup WebGL context
                const gl = this.canvas.getContext('webgl2', {
                    alpha: true,
                    antialias: false, // Disable for mobile performance
                    powerPreference: 'high-performance'
                });
                
                if (!gl) {
                    console.error('‚ùå WebGL not supported');
                    return;
                }
                
                this.gl = gl;
                console.log(`üì± Canvas setup: ${this.canvas.width}x${this.canvas.height}`);
            }
            
            async switchSystem(newSystem) {
                if (newSystem === this.currentSystem) return;
                
                console.log(`üîÑ Switching from ${this.currentSystem} to ${newSystem}`);
                
                // Load new system if needed
                await this.loadSystem(newSystem);
                
                // Update UI
                document.querySelectorAll('.system-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[onclick="switchSystem('${newSystem}')"]`).classList.add('active');
                
                this.currentSystem = newSystem;
                
                // Apply current parameters to new system
                this.updateCurrentSystem();
            }
            
            updateParameter(param, value) {
                this.parameters[param] = parseFloat(value);
                this.updateCurrentSystem();
            }
            
            updateCurrentSystem() {
                const engine = this.engines[this.currentSystem];
                if (engine && engine.updateParameters) {
                    engine.updateParameters(this.parameters);
                }
            }
            
            startRender() {
                const render = () => {
                    const engine = this.engines[this.currentSystem];
                    if (engine && engine.render) {
                        engine.render();
                    }
                    requestAnimationFrame(render);
                };
                render();
            }
        }

        // Global functions for mobile UI
        window.mobileEngine = new MobileVIB34DEngine();
        
        window.switchSystem = async (system) => {
            await window.mobileEngine.switchSystem(system);
        };
        
        window.updateParam = (param, value) => {
            window.mobileEngine.updateParameter(param, value);
        };
        
        window.toggleUI = () => {
            const overlay = document.getElementById('ui-overlay');
            overlay.classList.toggle('hidden');
        };
        
        window.generateFromLLM = async () => {
            const input = document.getElementById('llm-input');
            const description = input.value.trim();
            
            if (!description) {
                alert('Please enter a description first');
                return;
            }
            
            try {
                console.log('ü§ñ Generating parameters for:', description);
                
                // Call Firebase Function
                const response = await fetch('https://us-central1-vib34d-llm-engine.cloudfunctions.net/generateVIB34DParameters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });
                
                if (!response.ok) throw new Error('LLM request failed');
                
                const result = await response.json();
                const parameters = result.parameters;
                
                console.log('ü§ñ Generated parameters:', parameters);
                
                // Smart system selection for mobile
                let targetSystem = 'faceted';
                if (parameters.chaos > 0.7 && parameters.speed > 2.0) {
                    targetSystem = 'quantum';
                } else if (parameters.intensity > 0.8 && parameters.saturation > 0.8) {
                    targetSystem = 'holographic';
                }
                
                // Switch system first
                await window.switchSystem(targetSystem);
                
                // Apply parameters
                Object.entries(parameters).forEach(([param, value]) => {
                    window.updateParam(param, value);
                });
                
                // Update UI sliders
                document.querySelector('input[oninput*="chaos"]').value = parameters.chaos || 0.2;
                document.querySelector('input[oninput*="speed"]').value = parameters.speed || 1.0;
                document.querySelector('input[oninput*="intensity"]').value = parameters.intensity || 0.5;
                document.querySelector('input[oninput*="hue"]').value = parameters.hue || 200;
                
                input.value = ''; // Clear input
                
            } catch (error) {
                console.error('‚ùå LLM generation failed:', error);
                alert('AI generation failed. Please try again.');
            }
        };
        
        // Touch event handling for mobile
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchmove', (e) => {
            // Prevent page scrolling
            e.preventDefault();
        }, { passive: false });
        
        console.log('üì± VIB34D Mobile v4 ready');
    </script>
</body>
</html>
